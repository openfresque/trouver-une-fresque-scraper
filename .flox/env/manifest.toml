version = 1

[install]
python.pkg-path = "python3"
python.version = "3.13"
uv.pkg-path = "uv"
zlib.pkg-path = "zlib"
gcc-unwrapped.pkg-path = "gcc-unwrapped"
postgresql.pkg-path = "postgresql"
jq.pkg-path = "jq"

# Playwright from flake - provides playwright-driver  
playwright_driver.flake = "github:pietdevries94/playwright-web-flake#playwright-driver"
nodejs.pkg-path = "nodejs"

# Chromium for Playwright (Linux only, properly patched for NixOS)
chromium.pkg-path = "chromium"
chromium.systems = ["aarch64-linux", "x86_64-linux"]

# Tools
ffmpeg.pkg-path = "ffmpeg"

# helper tools
gum.pkg-path = "gum"
coreutils.pkg-path = "coreutils"


[vars]

[hook]
on-activate = '''
# Playwright configuration
export PLAYWRIGHT_SKIP_VALIDATE_HOST_REQUIREMENTS=true

# Point to writable cache directory for browsers
PLAYWRIGHT_BROWSERS_DIR="$FLOX_ENV_CACHE/playwright-browsers"
mkdir -p "$PLAYWRIGHT_BROWSERS_DIR"
export PLAYWRIGHT_BROWSERS_PATH="$PLAYWRIGHT_BROWSERS_DIR"

# Flox stuff
export FLOX_PYTHON_UV_CACHE_DIR="$FLOX_ENV_CACHE/python-uv"
mkdir -p "$FLOX_PYTHON_UV_CACHE_DIR"

export FLOX_PYTHON_UV_VENV_PATH="$FLOX_PYTHON_UV_CACHE_DIR/venv"
export FLOX_PYTHON_UV_VENV_INTERPRETER="$(cat "$FLOX_PYTHON_UV_CACHE_DIR/venv.interpreter" 2> /dev/null || echo false )"
export FLOX_PYTHON_UV_INTERPRETER="$(realpath $(which python3))"

# Make sure any tools are not attempting to use the Python interpreter from any
# existing virtual environment.
unset VIRTUAL_ENV

export UV_PROJECT_ENVIRONMENT="$FLOX_PYTHON_UV_VENV_PATH"

function indent() {
  echo -e '{{ Foreground "#cccccc" " │ "}}' | \
    gum format -t template --theme=auto
}

function with_spinner() {
  if [[ "$FLOX_ENVS_TESTING" == "1" ]]; then
    bash -c "$1"
  else
    echo
    gum spin \
      --show-error \
      --spinner line \
      --spinner.foreground="#cccccc" \
      --title " >>> $2 ..." \
      --title.foreground="#cccccc" \
        -- bash -c "$1"
    echo -en "\033[2A\033[K"
  fi
}

function ensure_venv() {
  uv venv -p "$FLOX_PYTHON_UV_INTERPRETER" "$FLOX_PYTHON_UV_VENV_PATH"
  source "$FLOX_PYTHON_UV_VENV_PATH/bin/activate"
}
export -f ensure_venv

function install_packages() {
  uv sync
}
export -f install_packages



indent && echo
indent && echo

if [ "$FLOX_PYTHON_UV_VENV_INTERPRETER" != "$FLOX_PYTHON_UV_INTERPRETER" ]; then
  with_spinner ensure_venv "Creating virtual environment"
  indent && echo -e "{{ Foreground \"#ffffff\" \"✅ Virtual environment was created.\" }}\n" \
    | gum format -t template
else
  indent && echo -e "{{ Foreground \"#ffffff\" \"✅ Virtual environment already exists.\" }}\n" \
    | gum format -t template
fi

indent && echo

if [ -f pyproject.toml ]; then
  with_spinner install_packages "Installing Python packages"
  indent && echo -e "{{ Foreground \"#ffffff\" \"✅ Python packages installed.\" }}\n" \
    | gum format -t template
else
  indent && echo -e "{{ Foreground \"#ffffff\" \"✅ No need to install Python packages.\" }}\n" \
    | gum format -t template
fi

indent && echo

# NOW fix the Playwright driver after packages are installed
PLAYWRIGHT_DRIVER_PATH="$(find /nix/store -maxdepth 1 -name "*playwright-driver*" -type d | head -1)"
if [ -d "$PLAYWRIGHT_DRIVER_PATH" ]; then
  # Point Python's playwright driver directory to use the Nix driver
  PYTHON_PLAYWRIGHT_DRIVER="$FLOX_PYTHON_UV_VENV_PATH/lib/python3.13/site-packages/playwright/driver"
  if [ -d "$PYTHON_PLAYWRIGHT_DRIVER" ]; then
    # Replace the broken node binary with a wrapper
    # Playwright calls: node cli.js <args>
    # We skip the first arg (cli.js path) since we hardcode it
    NODE_PATH="$(readlink -f $(which node))"
    rm -f "$PYTHON_PLAYWRIGHT_DRIVER/node"
    cat > "$PYTHON_PLAYWRIGHT_DRIVER/node" << WRAPPER
#!/bin/sh
shift  # Remove first argument (cli.js path)
exec "$NODE_PATH" "$PLAYWRIGHT_DRIVER_PATH/package/cli.js" "\$@"
WRAPPER
    chmod +x "$PYTHON_PLAYWRIGHT_DRIVER/node"
    
    # Link to Nix driver's package
    rm -rf "$PYTHON_PLAYWRIGHT_DRIVER/package"
    ln -sf "$PLAYWRIGHT_DRIVER_PATH/package" "$PYTHON_PLAYWRIGHT_DRIVER/package"
    
    indent && echo -e "{{ Foreground \"#ffffff\" \"✅ Playwright driver patched for NixOS.\" }}\n" \
      | gum format -t template
    
    # Create Chromium browser wrappers (same approach as playwright-web-flake)
    indent && echo
    BROWSERS_JSON="$PLAYWRIGHT_DRIVER_PATH/package/browsers.json"
    if [ -f "$BROWSERS_JSON" ]; then
      CHROMIUM_REV=$(jq -r '.browsers[] | select(.name == "chromium").revision' "$BROWSERS_JSON")
      CHROMIUM_HEADLESS_REV=$(jq -r '.browsers[] | select(.name == "chromium-headless-shell").revision' "$BROWSERS_JSON")
      FFMPEG_REV=$(jq -r '.browsers[] | select(.name == "ffmpeg").revision' "$BROWSERS_JSON")
      
      # Use architecture-appropriate directory name
      [ "$(uname -m)" = "aarch64" ] && CHROME_DIR="chrome-linux" || CHROME_DIR="chrome-linux64"
      
      # Link system Chromium to paths Playwright expects
      mkdir -p "$PLAYWRIGHT_BROWSERS_DIR/chromium-$CHROMIUM_REV/$CHROME_DIR"
      ln -sf "$(which chromium)" "$PLAYWRIGHT_BROWSERS_DIR/chromium-$CHROMIUM_REV/$CHROME_DIR/chrome"
      
      # Headless shell (Playwright uses underscores in path, not hyphens)
      mkdir -p "$PLAYWRIGHT_BROWSERS_DIR/chromium_headless_shell-$CHROMIUM_HEADLESS_REV/$CHROME_DIR"
      ln -sf "$(which chromium)" "$PLAYWRIGHT_BROWSERS_DIR/chromium_headless_shell-$CHROMIUM_HEADLESS_REV/$CHROME_DIR/headless_shell"
      
      # Link system ffmpeg
      mkdir -p "$PLAYWRIGHT_BROWSERS_DIR/ffmpeg-$FFMPEG_REV"
      ln -sf "$(which ffmpeg)" "$PLAYWRIGHT_BROWSERS_DIR/ffmpeg-$FFMPEG_REV/ffmpeg-linux"
      
      indent && echo -e "{{ Foreground \"#ffffff\" \"✅ Chromium browsers linked.\" }}\n" \
        | gum format -t template
    fi
  fi
fi

indent && echo
'''

[profile]
bash = '''
source "$FLOX_PYTHON_UV_VENV_PATH/bin/activate"
'''
fish = '''
source "$FLOX_PYTHON_UV_VENV_PATH/bin/activate.fish"
'''
tcsh = '''
source "$FLOX_PYTHON_UV_VENV_PATH/bin/activate.csh"
'''
zsh = '''
source "$FLOX_PYTHON_UV_VENV_PATH/bin/activate"
'''

[options]
systems = [
  "aarch64-darwin",
  "aarch64-linux",
  "x86_64-darwin",
  "x86_64-linux",
]
